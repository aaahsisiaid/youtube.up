<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>youtube.up - YouTube 動画アップローダー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js" type="module"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ヘッダー -->
    <header class="bg-red-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">youtube.up</h1>
            <div class="flex items-center space-x-4">
                <div id="auth-status" class="text-sm"></div>
                <button id="auth-button" class="bg-white text-red-600 px-4 py-2 rounded hover:bg-gray-100 transition-colors">
                    ログイン
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto p-6">
        <!-- アップロードセクション -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">動画・音声ファイルをアップロード</h2>
            
            <!-- ファイル選択 -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    ファイルを選択 (MP4, MP3, WAV)
                </label>
                <input type="file" id="file-input" multiple accept=".mp4,.mp3,.wav" 
                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                <p class="text-sm text-gray-500 mt-1">動画は最大128MB、サムネイルは最大2MB</p>
            </div>

            <!-- 一括設定 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">タイトルテンプレート</label>
                    <input type="text" id="title-template" placeholder="{filename} #{index}" value="{filename} #{index}"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">公開設定</label>
                    <select id="privacy-setting" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        <option value="private">非公開</option>
                        <option value="unlisted">限定公開</option>
                        <option value="public">公開</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">説明</label>
                <textarea id="description" rows="3" 
                          class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
                          placeholder="動画の説明を入力してください..."></textarea>
            </div>

            <!-- プレイリスト設定 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">プレイリストに追加</label>
                    <select id="playlist-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        <option value="">プレイリストを選択...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">または新規作成</label>
                    <input type="text" id="new-playlist-name" placeholder="新しいプレイリスト名" 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                </div>
            </div>

            <!-- サムネイルアップロード -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">サムネイル（オプション）</label>
                <input type="file" id="thumbnail-input" accept="image/*" 
                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
            </div>

            <!-- アップロードボタン -->
            <button id="upload-button" class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                アップロード開始
            </button>
        </div>

        <!-- 進捗セクション -->
        <div id="progress-section" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">アップロード進捗</h2>
            <div id="progress-container"></div>
        </div>

        <!-- ファイル一覧 -->
        <div id="file-list" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">選択されたファイル</h2>
            <div id="file-items"></div>
        </div>

        <!-- システム状態 -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">システム状態</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="font-medium">Google API:</span>
                    <span id="gapi-status" class="ml-2 text-yellow-600">初期化中...</span>
                </div>
                <div>
                    <span class="font-medium">FFmpeg:</span>
                    <span id="ffmpeg-status" class="ml-2 text-yellow-600">初期化中...</span>
                </div>
                <div>
                    <span class="font-medium">認証状態:</span>
                    <span id="auth-status-detail" class="ml-2 text-gray-600">未ログイン</span>
                </div>
            </div>
        </div>
    </main>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                <span>初期化中...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // FFmpegのインポート
        let FFmpegLib = null;
        try {
            FFmpegLib = await import('https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js');
        } catch (error) {
            console.warn('FFmpeg import failed:', error);
        }

        // グローバル変数
        let isAuthenticated = false;
        let ffmpegInstance = null;
        let selectedFiles = [];
        let gapiLoaded = false;

        // Google API設定
        const API_KEY = 'AIzaSyBuV5V7kB3lI8EQtuQ7qB3q8J7QBkQjaM';
        const CLIENT_ID = '320694443306-u0g4k8vc7v6a3e2calbcq7r7jl40bqc4p.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';

        // DOM要素
        const authButton = document.getElementById('auth-button');
        const authStatus = document.getElementById('auth-status');
        const authStatusDetail = document.getElementById('auth-status-detail');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const progressSection = document.getElementById('progress-section');
        const fileList = document.getElementById('file-list');
        const loadingOverlay = document.getElementById('loading-overlay');
        const gapiStatus = document.getElementById('gapi-status');
        const ffmpegStatus = document.getElementById('ffmpeg-status');

        // アプリケーション初期化
        async function initApp() {
            console.log('アプリケーションを初期化中...');
            showLoading(true);
            
            let gapiSuccess = false;
            let ffmpegSuccess = false;

            // Google API初期化
            try {
                await initGapiClient();
                gapiSuccess = true;
                gapiStatus.textContent = '準備完了';
                gapiStatus.className = 'ml-2 text-green-600';
            } catch (error) {
                console.error('Google API初期化失敗:', error);
                gapiStatus.textContent = 'エラー';
                gapiStatus.className = 'ml-2 text-red-600';
            }

            // FFmpeg初期化
            try {
                await initFFmpeg();
                ffmpegSuccess = true;
                ffmpegStatus.textContent = '準備完了';
                ffmpegStatus.className = 'ml-2 text-green-600';
            } catch (error) {
                console.error('FFmpeg初期化失敗:', error);
                ffmpegStatus.textContent = '利用不可';
                ffmpegStatus.className = 'ml-2 text-yellow-600';
            }

            // イベントリスナー設定
            setupEventListeners();

            if (gapiSuccess) {
                console.log('アプリケーション初期化完了');
            } else {
                alert('Google APIの初期化に失敗しました。ページを再読み込みしてください。');
            }
            
            showLoading(false);
        }

        // Google APIクライアント初期化
        async function initGapiClient() {
            console.log('Google APIクライアントを初期化中...');
            
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Google API読み込みがタイムアウトしました'));
                }, 10000);

                function checkGapi() {
                    if (window.gapi) {
                        clearTimeout(timeout);
                        gapi.load('auth2:client', {
                            callback: async () => {
                                try {
                                    await gapi.client.init({
                                        apiKey: API_KEY,
                                        clientId: CLIENT_ID,
                                        discoveryDocs: [DISCOVERY_DOC],
                                        scope: SCOPES
                                    });

                                    gapiLoaded = true;

                                    // 既にサインインしているかチェック
                                    const authInstance = gapi.auth2.getAuthInstance();
                                    if (authInstance && authInstance.isSignedIn.get()) {
                                        handleAuthSuccess(true);
                                    }

                                    console.log('Google APIクライアント初期化完了');
                                    resolve();
                                } catch (error) {
                                    console.error('GAPI client init エラー:', error);
                                    reject(error);
                                }
                            },
                            onerror: (error) => {
                                console.error('GAPI load エラー:', error);
                                reject(error);
                            }
                        });
                    } else {
                        // 100ms後に再試行
                        setTimeout(checkGapi, 100);
                    }
                }

                checkGapi();
            });
        }

        // FFmpeg初期化
        async function initFFmpeg() {
            console.log('FFmpegを初期化中...');
            
            if (!FFmpegLib) {
                throw new Error('FFmpegライブラリが読み込まれていません');
            }

            try {
                const { FFmpeg } = FFmpegLib;
                ffmpegInstance = new FFmpeg();
                
                ffmpegInstance.on('log', ({ message }) => {
                    console.log('FFmpeg:', message);
                });

                ffmpegInstance.on('progress', ({ progress }) => {
                    console.log(`FFmpeg進捗: ${Math.round(progress * 100)}%`);
                });

                await ffmpegInstance.load();
                console.log('FFmpeg初期化完了');
            } catch (error) {
                console.warn('FFmpeg初期化失敗。音声変換機能は利用できません:', error);
                ffmpegInstance = null;
                throw error;
            }
        }

        // イベントリスナー設定
        function setupEventListeners() {
            authButton.addEventListener('click', handleAuthClick);
            fileInput.addEventListener('change', handleFileSelection);
            uploadButton.addEventListener('click', handleUpload);
            
            // プレイリスト新規作成入力時
            document.getElementById('new-playlist-name').addEventListener('input', function() {
                if (this.value.trim()) {
                    document.getElementById('playlist-select').value = '';
                }
            });

            console.log('イベントリスナー設定完了');
        }

        // 認証クリック処理
        async function handleAuthClick() {
            console.log('認証ボタンがクリックされました');
            
            if (!gapiLoaded) {
                alert('Google APIが初期化されていません。ページを再読み込みしてください。');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (isAuthenticated) {
                    // サインアウト
                    await authInstance.signOut();
                    handleAuthSuccess(false);
                } else {
                    // サインイン
                    await authInstance.signIn();
                    handleAuthSuccess(true);
                }
            } catch (error) {
                console.error('認証エラー:', error);
                alert('認証に失敗しました。もう一度お試しください。');
            }
        }

        // 認証成功/失敗処理
        function handleAuthSuccess(signedIn = true) {
            isAuthenticated = signedIn;
            
            if (signedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                
                authStatus.textContent = `${profile.getName()} としてログイン中`;
                authStatusDetail.textContent = 'ログイン済み';
                authStatusDetail.className = 'ml-2 text-green-600';
                authButton.textContent = 'ログアウト';
                authButton.classList.remove('bg-white', 'text-red-600');
                authButton.classList.add('bg-red-700', 'text-white');
                
                loadPlaylists();
            } else {
                authStatus.textContent = '';
                authStatusDetail.textContent = '未ログイン';
                authStatusDetail.className = 'ml-2 text-gray-600';
                authButton.textContent = 'ログイン';
                authButton.classList.remove('bg-red-700', 'text-white');
                authButton.classList.add('bg-white', 'text-red-600');
                
                // プレイリストドロップダウンをクリア
                const playlistSelect = document.getElementById('playlist-select');
                playlistSelect.innerHTML = '<option value="">プレイリストを選択...</option>';
            }
        }

        // ユーザーのプレイリストを読み込み
        async function loadPlaylists() {
            try {
                const response = await gapi.client.youtube.playlists.list({
                    part: 'snippet',
                    mine: true,
                    maxResults: 50
                });

                const playlistSelect = document.getElementById('playlist-select');
                playlistSelect.innerHTML = '<option value="">プレイリストを選択...</option>';

                response.result.items.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.id;
                    option.textContent = playlist.snippet.title;
                    playlistSelect.appendChild(option);
                });
            } catch (error) {
                console.error('プレイリストの読み込みに失敗:', error);
            }
        }

        // ファイル選択処理
        function handleFileSelection(event) {
            selectedFiles = Array.from(event.target.files);
            displayFileList();
            
            if (selectedFiles.length > 0) {
                fileList.classList.remove('hidden');
                uploadButton.disabled = false;
            } else {
                fileList.classList.add('hidden');
                uploadButton.disabled = true;
            }
        }

        // 選択されたファイルを表示
        function displayFileList() {
            const fileItems = document.getElementById('file-items');
            fileItems.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 border rounded-lg mb-2';
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <div class="font-medium">${file.name}</div>
                    <div class="text-sm text-gray-500">
                        ${(file.size / (1024 * 1024)).toFixed(2)} MB - ${file.type}
                        ${file.type.startsWith('audio/') ? ' (動画に変換されます)' : ''}
                    </div>
                `;
                
                const removeButton = document.createElement('button');
                removeButton.className = 'text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded';
                removeButton.textContent = '削除';
                removeButton.onclick = () => removeFile(index);
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeButton);
                fileItems.appendChild(fileItem);
            });
        }

        // ファイルを選択から削除
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
            
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                uploadButton.disabled = true;
            }
        }

        // アップロード処理
        async function handleUpload() {
            if (!isAuthenticated) {
                alert('まずはログインしてください');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('アップロードするファイルを選択してください');
                return;
            }

            // ファイルサイズチェック
            const oversizedFiles = selectedFiles.filter(file => file.size > 128 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                alert(`以下のファイルは128MBを超えています：\n${oversizedFiles.map(f => f.name).join('\n')}`);
                return;
            }

            uploadButton.disabled = true;
            progressSection.classList.remove('hidden');

            try {
                // プレイリスト作成（指定されている場合）
                let playlistId = document.getElementById('playlist-select').value;
                const newPlaylistName = document.getElementById('new-playlist-name').value.trim();
                
                if (newPlaylistName) {
                    playlistId = await createPlaylist(newPlaylistName);
                }

                // 各ファイルを処理
                for (let i = 0; i < selectedFiles.length; i++) {
                    await processFile(selectedFiles[i], i + 1, playlistId);
                }

                alert('すべてのアップロードが完了しました！');
            } catch (error) {
                console.error('アップロード処理失敗:', error);
                alert('アップロードに失敗しました: ' + error.message);
            } finally {
                uploadButton.disabled = false;
            }
        }

        // 個別ファイル処理
        async function processFile(file, index, playlistId) {
            const progressId = `progress-${index}`;
            addProgressItem(progressId, file.name, index);

            try {
                let videoFile = file;

                // 音声ファイルの場合は動画に変換
                if (file.type.startsWith('audio/')) {
                    if (!ffmpegInstance) {
                        throw new Error('音声変換機能が利用できません');
                    }
                    updateProgress(progressId, '音声を動画に変換中...', 0);
                    videoFile = await convertAudioToVideo(file, progressId);
                }

                // 動画アップロード
                updateProgress(progressId, '動画をアップロード中...', 20);
                const videoId = await uploadVideo(videoFile, index, progressId);

                // サムネイルアップロード（指定されている場合）
                const thumbnailFile = document.getElementById('thumbnail-input').files[0];
                if (thumbnailFile) {
                    updateProgress(progressId, 'サムネイルをアップロード中...', 90);
                    await uploadThumbnail(videoId, thumbnailFile);
                }

                // プレイリストに追加（指定されている場合）
                if (playlistId) {
                    updateProgress(progressId, 'プレイリストに追加中...', 95);
                    await addToPlaylist(playlistId, videoId);
                }

                updateProgress(progressId, '完了', 100);
            } catch (error) {
                updateProgress(progressId, `エラー: ${error.message}`, 0);
                throw error;
            }
        }

        // 音声を動画に変換
        async function convertAudioToVideo(audioFile, progressId) {
            try {
                const audioData = new Uint8Array(await audioFile.arrayBuffer());
                await ffmpegInstance.writeFile('input.mp3', audioData);

                updateProgress(progressId, '音声変換中... (これには時間がかかる場合があります)', 10);

                await ffmpegInstance.exec([
                    '-f', 'lavfi',
                    '-i', 'color=c=black:s=1280x720:d=1',
                    '-i', 'input.mp3',
                    '-c:v', 'libx264',
                    '-c:a', 'aac',
                    '-shortest',
                    '-y',
                    'output.mp4'
                ]);

                const videoData = await ffmpegInstance.readFile('output.mp4');
                const videoBlob = new Blob([videoData.buffer], { type: 'video/mp4' });
                
                return new File([videoBlob], audioFile.name.replace(/\.[^/.]+$/, '.mp4'), {
                    type: 'video/mp4'
                });
            } catch (error) {
                console.error('音声変換失敗:', error);
                throw new Error('音声ファイルの動画変換に失敗しました');
            }
        }

        // YouTubeに動画アップロード
        async function uploadVideo(file, index, progressId) {
            const titleTemplate = document.getElementById('title-template').value || '{filename} #{index}';
            const title = titleTemplate
                .replace('{filename}', file.name.replace(/\.[^/.]+$/, ''))
                .replace('{index}', index);
            
            const description = document.getElementById('description').value || '';
            const privacy = document.getElementById('privacy-setting').value;

            const metadata = {
                snippet: {
                    title: title,
                    description: description,
                    categoryId: '22' // People & Books
                },
                status: {
                    privacyStatus: privacy
                }
            };

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                
                formData.append('metadata', new Blob([JSON.stringify(metadata)], {
                    type: 'application/json'
                }));
                formData.append('media', file);

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const progress = Math.round((e.loaded / e.total) * 70) + 20; // 20-90%の範囲
                        updateProgress(progressId, 'アップロード中...', progress);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.id);
                        } catch (error) {
                            reject(new Error('レスポンス形式が無効です'));
                        }
                    } else {
                        reject(new Error(`アップロード失敗: ${xhr.status} ${xhr.statusText}`));
                    }
                });

                xhr.addEventListener('error', () => {
                    reject(new Error('アップロード失敗: ネットワークエラー'));
                });

                const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                
                xhr.open('POST', 'https://www.googleapis.com/upload/youtube/v3/videos?uploadType=multipart&part=snippet,status');
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                xhr.send(formData);
            });
        }

        // サムネイルアップロード
        async function uploadThumbnail(videoId, thumbnailFile) {
            if (thumbnailFile.size > 2 * 1024 * 1024) {
                throw new Error('サムネイルファイルは2MB以下である必要があります');
            }

            const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        resolve();
                    } else {
                        reject(new Error(`サムネイルアップロード失敗: ${xhr.status}`));
                    }
                });

                xhr.addEventListener('error', () => {
                    reject(new Error('サムネイルアップロードに失敗しました'));
                });

                xhr.open('POST', `https://www.googleapis.com/upload/youtube/v3/thumbnails/set?videoId=${videoId}`);
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                xhr.setRequestHeader('Content-Type', thumbnailFile.type);
                xhr.send(thumbnailFile);
            });
        }

        // プレイリスト作成
        async function createPlaylist(name) {
            try {
                const response = await gapi.client.youtube.playlists.insert({
                    part: 'snippet,status',
                    resource: {
                        snippet: {
                            title: name,
                            description: `youtube.upで作成 ${new Date().toLocaleDateString('ja-JP')}`
                        },
                        status: {
                            privacyStatus: 'private'
                        }
                    }
                });

                return response.result.id;
            } catch (error) {
                console.error('プレイリスト作成失敗:', error);
                throw new Error('プレイリストの作成に失敗しました');
            }
        }

        // プレイリストに動画追加
        async function addToPlaylist(playlistId, videoId) {
            try {
                await gapi.client.youtube.playlistItems.insert({
                    part: 'snippet',
                    resource: {
                        snippet: {
                            playlistId: playlistId,
                            resourceId: {
                                kind: 'youtube#video',
                                videoId: videoId
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('プレイリストへの追加失敗:', error);
                throw new Error('プレイリストへの動画追加に失敗しました');
            }
        }

        // 進捗管理
        function addProgressItem(id, filename, index) {
            const progressContainer = document.getElementById('progress-container');
            const progressItem = document.createElement('div');
            progressItem.id = id;
            progressItem.className = 'mb-4 p-4 border rounded-lg';
            progressItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">${
