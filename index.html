<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 動画アップロード - youtube.up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        .upload-progress { transition: width 0.3s ease-in-out; }
        .error-message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        details summary::-webkit-details-marker { display: none; }
        details summary { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-3xl bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
        <h1 class="text-2xl font-bold mb-4 text-center">YouTube に動画をアップロード - youtube.up</h1>
        
        <!-- ログイン前 -->
        <div id="preSignIn" class="pre-sign-in">
            <button onclick="handleAuthClick()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-200">Google ログイン</button>
            <p class="text-red-600 mt-2 text-sm">注: このアプリはテスト中のため、「このアプリは検証されていません」という警告が表示されます。「詳細を表示」>「続行」をクリックしてください。テストユーザー（例: a6068376@gmail.com）であることを確認してください。</p>
        </div>

        <!-- ログイン後 -->
        <div id="postSignIn" class="post-sign-in hidden">
            <!-- 一括設定 -->
            <details class="mb-4 border rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                <summary class="text-lg font-semibold">一括設定（クリックで展開）</summary>
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium">タイトル（例: {filename}_{index}）:</label>
                        <input type="text" id="batchTitle" placeholder="{filename}" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">概要:</label>
                        <textarea id="batchDescription" class="w-full border rounded p-2 bg-white dark:bg-gray-600" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">公開設定:</label>
                        <select id="batchPrivacy" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                            <option value="">変更しない</option>
                            <option value="private">非公開</option>
                            <option value="unlisted">限定公開</option>
                            <option value="public">公開</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">サムネイル（全動画共通）:</label>
                        <input type="file" id="batchThumbnail" accept="image/jpeg,image/png" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">再生リスト（全動画共通）:</label>
                        <select id="batchPlaylist" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                            <option value="">なし</option>
                        </select>
                        <input type="text" id="batchNewPlaylist" placeholder="新しい再生リストのタイトル" class="w-full border rounded p-2 mt-2 bg-white dark:bg-gray-600">
                        <button onclick="createBatchPlaylist()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">新規作成</button>
                    </div>
                    <button onclick="applyBatchSettings()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded transition duration-200">一括適用</button>
                </div>
            </details>

            <!-- ファイル選択 -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">動画/音声ファイル（複数選択可）:</label>
                <input type="file" id="mediaFiles" accept="video/*,audio/*" multiple class="w-full border rounded p-2 bg-gray-50 dark:bg-gray-700">
            </div>

            <!-- ファイルリスト -->
            <div id="mediaList" class="mb-4 overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-600">
                            <th class="border p-2 text-left">ファイル名</th>
                            <th class="border p-2 text-left">タイトル</th>
                            <th class="border p-2 text-left">公開設定</th>
                            <th class="border p-2 text-left">サムネイル</th>
                            <th class="border p-2 text-left">再生リスト</th>
                        </tr>
                    </thead>
                    <tbody id="mediaTableBody"></tbody>
                </table>
            </div>

            <!-- コントロール -->
            <button onclick="startUpload()" id="uploadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition duration-200" disabled>アップロード開始</button>
            <div id="progressContainer" class="mt-4 hidden">
                <p id="progressText" class="text-sm mb-2"></p>
                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full upload-progress" style="width: 0%"></div>
                </div>
            </div>
            <div id="errorContainer" class="mt-4 text-red-600 text-sm hidden"></div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM';
        const SCOPES = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'];
        let accessToken = null;
        let tokenClient = null;
        let mediaQueue = [];
        let currentUploadIndex = 0;
        let playlists = [];
        let ffmpeg = null;

        async function initFFmpeg() {
            ffmpeg = FFmpeg.createFFmpeg({ log: true });
            await ffmpeg.load();
        }

        async function convertAudioToVideo(audioFile, imageFile) {
            const defaultImage = new Blob([await (await fetch('https://via.placeholder.com/1280x720.png')).blob()], { type: 'image/png' });
            const image = imageFile || defaultImage;
            const audioName = audioFile.name.split('.')[0];

            // ファイルを FFmpeg に書き込み
            ffmpeg.FS('writeFile', 'audio.' + audioFile.name.split('.').pop(), await audioFile.arrayBuffer());
            ffmpeg.FS('writeFile', 'image.png', await image.arrayBuffer());

            // 動画変換コマンド
            await ffmpeg.run(
                '-i', 'audio.' + audioFile.name.split('.').pop(),
                '-i', 'image.png',
                '-c:v', 'libx264',
                '-c:a', 'aac',
                '-vf', 'scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2',
                '-shortest',
                '-f', 'mp4',
                `${audioName}.mp4`
            );

            // 変換結果を取得
            const data = ffmpeg.FS('readFile', `${audioName}.mp4`);
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            ffmpeg.FS('unlink', `${audioName}.mp4`);
            ffmpeg.FS('unlink', 'audio.' + audioFile.name.split('.').pop());
            ffmpeg.FS('unlink', 'image.png');

            return new File([videoBlob], `${audioName}.mp4`, { type: 'video/mp4' });
        }

        function initClient() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS
                }).then(() => {
                    console.log('YouTube API クライアント初期化完了');
                    if (accessToken) {
                        loadPlaylists();
                    }
                }).catch(error => {
                    showError('YouTube API 初期化に失敗しました: ' + JSON.stringify(error));
                });
            });
        }

        function handleAuthClick() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        showError('認証に失敗しました: ' + JSON.stringify(response) + '\nテストユーザー（a6068376@gmail.com）であるか、「続行」を選択してください。');
                        return;
                    }
                    accessToken = response.access_token;
                    document.getElementById('preSignIn').classList.add('hidden');
                    document.getElementById('postSignIn').classList.remove('hidden');
                    loadPlaylists();
                }
            });
            tokenClient.requestAccessToken();
        }

        function loadPlaylists() {
            gapi.client.youtube.playlists.list({
                part: 'snippet',
                mine: true,
                maxResults: 50
            }).then(response => {
                playlists = response.result.items || [];
                updateBatchPlaylistOptions();
                updateMediaInputs();
            }).catch(error => {
                showError('再生リストの取得に失敗しました: ' + JSON.stringify(error));
            });
        }

        function createPlaylist(title, callback) {
            gapi.client.youtube.playlists.insert({
                part: 'snippet,status',
                resource: {
                    snippet: { title, description: '自動作成された再生リスト' },
                    status: { privacyStatus: 'private' }
                }
            }).then(response => {
                playlists.push(response.result);
                callback(response.result.id);
            }).catch(error => {
                showError('再生リストの作成に失敗しました: ' + JSON.stringify(error));
            });
        }

        function createBatchPlaylist() {
            const title = document.getElementById('batchNewPlaylist').value;
            if (!title) {
                showError('再生リストのタイトルを入力してください');
                return;
            }
            createPlaylist(title, (playlistId) => {
                updateBatchPlaylistOptions();
                document.getElementById('batchPlaylist').value = playlistId;
                updateMediaInputs();
            });
        }

        function ensureValidToken(callback) {
            if (!tokenClient) {
                showError('ログインセッションが無効です。再度ログインしてください。');
                document.getElementById('preSignIn').classList.remove('hidden');
                document.getElementById('postSignIn').classList.add('hidden');
                return;
            }
            tokenClient.requestAccessToken({
                prompt: '',
                callback: (response) => {
                    if (response.error) {
                        showError('トークンの更新に失敗しました: ' + JSON.stringify(response));
                        return;
                    }
                    accessToken = response.access_token;
                    callback();
                }
            });
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.classList.remove('hidden');
            errorContainer.innerHTML += `<p class="error-message">${message}</p>`;
            console.error(message);
        }

        function clearErrors() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.classList.add('hidden');
            errorContainer.innerHTML = '';
        }

        function updateBatchPlaylistOptions() {
            const batchPlaylist = document.getElementById('batchPlaylist');
            batchPlaylist.innerHTML = '<option value="">なし</option>' + 
                playlists.map(p => `<option value="${p.id}">${p.snippet.title}</option>`).join('');
        }

        function updateMediaInputs() {
            const mediaFiles = document.getElementById('mediaFiles').files;
            const mediaTableBody = document.getElementById('mediaTableBody');
            mediaTableBody.innerHTML = '';
            mediaQueue = [];

            if (mediaFiles.length === 0) {
                document.getElementById('uploadButton').disabled = true;
                return;
            }

            Array.from(mediaFiles).forEach((file, index) => {
                const isAudio = file.type.startsWith('audio/');
                const row = document.createElement('tr');
                row.className = 'border-t';
                row.innerHTML = `
                    <td class="border p-2">${file.name}${isAudio ? ' (音声→動画変換)' : ''}</td>
                    <td class="border p-2">
                        <input type="text" id="title${index}" value="${file.name.replace(/\.[^/.]+$/, '')}" class="w-full border rounded p-1 bg-white dark:bg-gray-600">
                    </td>
                    <td class="border p-2">
                        <select id="privacy${index}" class="w-full border rounded p-1 bg-white dark:bg-gray-600">
                            <option value="private">非公開</option>
                            <option value="unlisted">限定公開</option>
                            <option value="public">公開</option>
                        </select>
                    </td>
                    <td class="border p-2">
                        <input type="file" id="thumbnail${index}" accept="image/jpeg,image/png" class="w-full border rounded p-1 bg-white dark:bg-gray-600">
                    </td>
                    <td class="border p-2">
                        <select id="playlist${index}" class="w-full border rounded p-1 bg-white dark:bg-gray-600">
                            <option value="">なし</option>
                            ${playlists.map(p => `<option value="${p.id}">${p.snippet.title}</option>`).join('')}
                        </select>
                    </td>
                `;
                mediaTableBody.appendChild(row);
                mediaQueue.push({ file, index, isAudio });
            });

            document.getElementById('uploadButton').disabled = false;
        }

        function applyBatchSettings() {
            const batchTitle = document.getElementById('batchTitle').value;
            const batchDescription = document.getElementById('batchDescription').value;
            const batchPrivacy = document.getElementById('batchPrivacy').value;
            const batchThumbnail = document.getElementById('batchThumbnail').files[0];
            const batchPlaylist = document.getElementById('batchPlaylist').value;

            mediaQueue.forEach(({ file, index }) => {
                if (batchTitle) {
                    const title = batchTitle
                        .replace('{filename}', file.name.replace(/\.[^/.]+$/, ''))
                        .replace('{index}', index + 1);
                    document.getElementById(`title${index}`).value = title;
                }
                if (batchDescription) {
                    document.getElementById(`description${index}`).value = batchDescription;
                }
                if (batchPrivacy) {
                    document.getElementById(`privacy${index}`).value = batchPrivacy;
                }
                if (batchPlaylist) {
                    document.getElementById(`playlist${index}`).value = batchPlaylist;
                }
                // サムネイルは手動でコピー（input 要素の値をプログラムで変更不可）
            });

            if (batchThumbnail) {
                alert('サムネイルを一括適用するには、各行のサムネイル入力欄に手動で同じファイルを設定してください。');
            }
        }

        async function startUpload() {
            if (mediaQueue.length === 0) {
                showError('ファイルが選択されていません');
                return;
            }
            clearErrors();
            currentUploadIndex = 0;
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('uploadButton').disabled = true;
            if (!ffmpeg) await initFFmpeg();
            uploadNextMedia();
        }

        async function uploadNextMedia() {
            if (currentUploadIndex >= mediaQueue.length) {
                document.getElementById('progressText').textContent = 'すべてのアップロードが完了しました！';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('uploadButton').disabled = false;
                return;
            }

            const { file, index, isAudio } = mediaQueue[currentUploadIndex];
            const title = document.getElementById(`title${index}`).value || 'テスト動画';
            const description = document.getElementById(`description${index}`).value || 'HTMLとJSでアップロード';
            const privacyStatus = document.getElementById(`privacy${index}`).value;
            const thumbnailFile = document.getElementById(`thumbnail${index}`).files[0];
            const playlistId = document.getElementById(`playlist${index}`).value;

            document.getElementById('progressText').textContent = `処理中: ${file.name} (${currentUploadIndex + 1}/${mediaQueue.length})`;
            document.getElementById('progressBar').style.width = `${(currentUploadIndex / mediaQueue.length) * 100}%`;

            let uploadFile = file;
            if (isAudio) {
                try {
                    document.getElementById('progressText').textContent = `音声変換中: ${file.name}`;
                    uploadFile = await convertAudioToVideo(file, thumbnailFile);
                } catch (e) {
                    showError(`音声変換エラー (${file.name}): ${e.message}`);
                    currentUploadIndex++;
                    uploadNextMedia();
                    return;
                }
            }

            if (uploadFile.size > 128 * 1024 * 1024) {
                showError(`ファイルが大きすぎます: ${uploadFile.name}（最大 128MB）`);
                currentUploadIndex++;
                uploadNextMedia();
                return;
            }

            const metadata = {
                snippet: { title, description, categoryId: '22' },
                status: { privacyStatus }
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('media', uploadFile);

            ensureValidToken(() => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status&uploadType=multipart', true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);

                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        console.log(`アップロード進捗 (${uploadFile.name}): ${percent.toFixed(2)}%`);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        const videoId = response.id;
                        console.log(`アップロード成功: ${uploadFile.name}, ビデオ ID: ${videoId}`);

                        if (thumbnailFile) {
                            uploadThumbnail(videoId, thumbnailFile);
                        }

                        if (playlistId) {
                            addToPlaylist(videoId, playlistId);
                        }

                        currentUploadIndex++;
                        document.getElementById('progressBar').style.width = `${((currentUploadIndex) / mediaQueue.length) * 100}%`;
                        uploadNextMedia();
                    } else {
                        let errorMsg = xhr.responseText || '不明なエラー';
                        try {
                            const errorJson = JSON.parse(errorMsg);
                            if (errorJson.error && errorJson.error.reason === 'uploadLimitExceeded') {
                                errorMsg = `YouTube の動画アップロード制限に達しました: ${uploadFile.name}。電話番号を検証するか、別のアカウントを試してください。`;
                            }
                        } catch (e) {}
                        showError(`アップロード失敗 (${uploadFile.name}): ${xhr.status} ${xhr.statusText}\n詳細: ${errorMsg}`);
                        currentUploadIndex++;
                        uploadNextMedia();
                    }
                };

                xhr.onerror = () => {
                    showError(`ネットワークエラー: ${uploadFile.name}`);
                    currentUploadIndex++;
                    uploadNextMedia();
                };

                xhr.send(formData);
            });
        }

        function uploadThumbnail(videoId, thumbnailFile) {
            if (thumbnailFile.size > 2 * 1024 * 1024) {
                showError(`サムネイルが大きすぎます: ${thumbnailFile.name}（最大 2MB）`);
                return;
            }

            const formData = new FormData();
            formData.append('file', thumbnailFile);

            ensureValidToken(() => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://www.googleapis.com/upload/youtube/v3/thumbnails/set?videoId=${videoId}&uploadType=media`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        console.log(`サムネイルアップロード成功: ${videoId}`);
                    } else {
                        showError(`サムネイルアップロード失敗 (${videoId}): ${xhr.status} ${xhr.statusText}`);
                    }
                };

                xhr.onerror = () => {
                    showError(`サムネイルネットワークエラー: ${videoId}`);
                };

                xhr.send(formData);
            });
        }

        function addToPlaylist(videoId, playlistId) {
            ensureValidToken(() => {
                gapi.client.youtube.playlistItems.insert({
                    part: 'snippet',
                    resource: {
                        snippet: {
                            playlistId: playlistId,
                            resourceId: { kind: 'youtube#video', videoId }
                        }
                    }
                }).then(() => {
                    console.log(`再生リストに追加: ${videoId}`);
                }).catch(error => {
                    showError('再生リストへの追加に失敗しました: ' + JSON.stringify(error));
                });
            });
        }

        document.getElementById('mediaFiles').addEventListener('change', updateMediaInputs);
        initClient();
    </script>
</body>
</html>
