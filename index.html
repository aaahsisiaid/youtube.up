<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>YouTube 動画アップロード</title>
    <style>
        .pre-sign-in { display: block; }
        .post-sign-in { display: none; }
        .signed-in .pre-sign-in { display: none; }
        .signed-in .post-sign-in { display: block; }
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        input { margin: 10px; }
    </style>
</head>
<body>
    <h1>YouTube に動画をアップロード</h1>
    <span id="signinButton" class="pre-sign-in">
        <button onclick="handleAuthClick()">Google ログイン</button>
    </span>
    <div class="post-sign-in">
        <input type="file" id="videoFile" accept="video/*">
        <button onclick="uploadVideo()">アップロード</button>
    </div>

    <!-- Google Identity Services ライブラリ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- YouTube API クライアントライブラリ -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM';
        const SCOPE = 'https://www.googleapis.com/auth/youtube.upload';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'];
        let accessToken = null;

        // GIS 認証の初期化
        function initClient() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS
                }).then(() => {
                    console.log('YouTube API クライアント初期化完了');
                }).catch(error => {
                    console.error('YouTube API 初期化エラー:', JSON.stringify(error, null, 2));
                    alert('YouTube API 初期化に失敗しました: ' + JSON.stringify(error));
                });
            });
        }

        // Google ログイン処理
        function handleAuthClick() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                callback: (response) => {
                    if (response.error) {
                        console.error('認証エラー:', JSON.stringify(response, null, 2));
                        alert('認証に失敗しました: ' + JSON.stringify(response));
                        return;
                    }
                    accessToken = response.access_token;
                    document.body.className = 'signed-in';
                    console.log('認証成功、アクセストークン:', accessToken);
                }
            });
            client.requestAccessToken();
        }

        // 動画アップロード
        function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('動画ファイルを選択してください');
                return;
            }
            if (!accessToken) {
                alert('先に Google ログインしてください');
                return;
            }

            const metadata = {
                snippet: {
                    title: 'テスト動画',
                    description: 'HTMLとJSでアップロードした動画',
                    categoryId: '22' // People & Blogs
                },
                status: {
                    privacyStatus: 'private'
                }
            };

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xhr.setRequestHeader('Content-Type', 'multipart/related; boundary=foo_bar_baz');

            let body = '--foo_bar_baz\r\n';
            body += 'Content-Type: application/json; charset=UTF-8\r\n\r\n';
            body += JSON.stringify(metadata) + '\r\n';
            body += '--foo_bar_baz\r\n';
            body += 'Content-Type: ' + file.type + '\r\n';
            body += 'Content-Transfer-Encoding: binary\r\n\r\n';

            const reader = new FileReader();
            reader.onload = () => {
                body += reader.result + '\r\n';
                body += '--foo_bar_baz--';
                xhr.send(body);
            };
            reader.readAsBinaryString(file);

            xhr.onload = () => {
                if (xhr.status === 200) {
                    alert('アップロード成功！');
                    console.log(JSON.parse(xhr.responseText));
                } else {
                    alert('アップロード失敗: ' + xhr.statusText);
                    console.error(xhr.responseText);
                }
            };
            xhr.onerror = () => {
                alert('ネットワークエラー');
                console.error('ネットワークエラー');
            };
        }

        // 初期化
        initClient();
    </script>
</body>
</html>
