<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 動画アップロード - youtube.up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script>
    <style>
        .upload-progress {
            transition: width 0.3s ease-in-out;
        }
        .error-message {
            animation: fadeIn 0.3s ease-in;
        }
        .applied {
            background-color: #d1fae5;
            transition: background-color 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-3xl bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
        <h1 class="text-2xl font-bold mb-4 text-center">YouTube に動画をアップロード - youtube.up</h1>
        
        <!-- ログイン前 -->
        <div id="preSignIn" class="pre-sign-in">
            <button onclick="handleAuthClick()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-200">Google ログイン</button>
            <p class="text-red-600 mt-2 text-sm">注: このアプリはテスト中のため、「このアプリは検証されていません」という警告が表示されます。「詳細を表示」>「続行」をクリックしてください。テストユーザー（例: a6068376@gmail.com）であることを確認してください。</p>
        </div>

        <!-- ログイン後 -->
        <div id="postSignIn" class="post-sign-in hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">動画/音声ファイル（複数選択可）:</label>
                <input type="file" id="videoFiles" accept="video/*,audio/*" multiple class="w-full border rounded p-2 bg-gray-50 dark:bg-gray-700">
            </div>

            <!-- 一括設定フォーム -->
            <div id="bulkSettings" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                <h2 class="text-lg font-semibold mb-2">一括設定</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium">タイトル</label>
                        <input type="text" id="bulkTitle" class="w-full border rounded p-2 bg-white dark:bg-gray-600" placeholder="すべての動画に適用">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">説明</label>
                        <textarea id="bulkDescription" class="w-full border rounded p-2 bg-white dark:bg-gray-600" rows="3" placeholder="すべての動画に適用"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">公開設定</label>
                        <select id="bulkPrivacy" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                            <option value="">選択しない</option>
                            <option value="private">非公開</option>
                            <option value="unlisted">限定公開</option>
                            <option value="public">公開</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">サムネイル（動画の背景画像にも使用可）</label>
                        <input type="file" id="bulkThumbnail" accept="image/jpeg,image/png" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">再生リスト</label>
                        <select id="bulkPlaylist" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                            <option value="">選択しない</option>
                        </select>
                        <input type="text" id="bulkNewPlaylist" placeholder="新しい再生リストのタイトル" class="w-full border rounded p-2 mt-2 bg-white dark:bg-gray-600">
                        <button onclick="createBulkPlaylist()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">新規作成</button>
                    </div>
                    <button onclick="applyBulkSettings()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded transition duration-200">一括適用</button>
                </div>
            </div>

            <!-- 動画ごとの設定 -->
            <div id="videoList" class="space-y-4 mb-4"></div>
            <button onclick="startUpload()" id="uploadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition duration-200" disabled>アップロード開始</button>
            <div id="progressContainer" class="mt-4 hidden">
                <p id="progressText" class="text-sm mb-2"></p>
                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full upload-progress" style="width: 0%"></div>
                </div>
            </div>
            <div id="errorContainer" class="mt-4 text-red-600 text-sm hidden"></div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM';
        const SCOPES = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'];
        let accessToken = null;
        let tokenClient = null;
        let videoQueue = [];
        let currentUploadIndex = 0;
        let playlists = [];
        let ffmpeg = null;

        async function initFFmpeg() {
            ffmpeg = FFmpeg.createFFmpeg({ log: true });
            await ffmpeg.load();
            console.log('FFmpeg loaded');
        }

        function initClient() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS
                }).then(() => {
                    console.log('YouTube API クライアント初期化完了');
                    if (accessToken) {
                        loadPlaylists();
                    }
                }).catch(error => {
                    showError('YouTube API 初期化に失敗しました: ' + JSON.stringify(error));
                });
            });
        }

        function handleAuthClick() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        showError('認証に失敗しました: ' + JSON.stringify(response) + '\nテストユーザー（a6068376@gmail.com）であるか、「続行」を選択してください。');
                        return;
                    }
                    accessToken = response.access_token;
                    document.body.classList.add('signed-in');
                    document.getElementById('preSignIn').classList.add('hidden');
                    document.getElementById('postSignIn').classList.remove('hidden');
                    loadPlaylists();
                }
            });
            tokenClient.requestAccessToken();
        }

        function loadPlaylists() {
            gapi.client.youtube.playlists.list({
                part: 'snippet',
                mine: true,
                maxResults: 50
            }).then(response => {
                playlists = response.result.items || [];
                updateVideoInputs();
                updateBulkPlaylistOptions();
            }).catch(error => {
                showError('再生リストの取得に失敗しました: ' + JSON.stringify(error));
            });
        }

        function updateBulkPlaylistOptions() {
            const bulkPlaylistSelect = document.getElementById('bulkPlaylist');
            bulkPlaylistSelect.innerHTML = '<option value="">選択しない</option>';
            playlists.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.text = p.snippet.title;
                bulkPlaylistSelect.appendChild(option);
            });
        }

        function createPlaylist(title, callback) {
            gapi.client.youtube.playlists.insert({
                part: 'snippet,status',
                resource: {
                    snippet: { title, description: '自動作成された再生リスト' },
                    status: { privacyStatus: 'private' }
                }
            }).then(response => {
                playlists.push(response.result);
                callback(response.result.id);
            }).catch(error => {
                showError('再生リストの作成に失敗しました: ' + JSON.stringify(error));
            });
        }

        function createBulkPlaylist() {
            const title = document.getElementById('bulkNewPlaylist').value;
            if (!title) {
                showError('再生リストのタイトルを入力してください');
                return;
            }
            createPlaylist(title, (playlistId) => {
                updateBulkPlaylistOptions();
                document.getElementById('bulkPlaylist').value = playlistId;
                document.getElementById('bulkNewPlaylist').value = '';
            });
        }

        function ensureValidToken(callback) {
            if (!tokenClient) {
                showError('ログインセッションが無効です。再度ログインしてください。');
                document.body.classList.remove('signed-in');
                document.getElementById('preSignIn').classList.remove('hidden');
                document.getElementById('postSignIn').classList.add('hidden');
                return;
            }
            tokenClient.requestAccessToken({
                prompt: '',
                callback: (response) => {
                    if (response.error) {
                        showError('トークンの更新に失敗しました: ' + JSON.stringify(response));
                        return;
                    }
                    accessToken = response.access_token;
                    callback();
                }
            });
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.classList.remove('hidden');
            errorContainer.innerHTML += `<p class="error-message">${message}</p>`;
            console.error(message);
        }

        function clearErrors() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.classList.add('hidden');
            errorContainer.innerHTML = '';
        }

        async function convertAudioToVideo(audioFile, thumbnailFile) {
            if (!ffmpeg) {
                showError('FFmpeg が初期化されていません');
                return null;
            }

            document.getElementById('progressText').textContent = `音声変換中: ${audioFile.name}`;
            document.getElementById('progressContainer').classList.remove('hidden');

            try {
                // デフォルト画像（黒背景）またはサムネイルを使用
                const imgData = thumbnailFile ? await thumbnailFile.arrayBuffer() : new Uint8Array(0);
                const imgName = thumbnailFile ? thumbnailFile.name : 'default.jpg';

                // FFmpeg にファイルを書き込み
                ffmpeg.FS('writeFile', audioFile.name, new Uint8Array(await audioFile.arrayBuffer()));
                if (thumbnailFile) {
                    ffmpeg.FS('writeFile', imgName, new Uint8Array(imgData));
                } else {
                    // デフォルト黒背景画像を生成
                    await ffmpeg.run('-f', 'lavfi', '-i', 'color=c=black:s=1280x720:d=1', '-vframes', '1', 'default.jpg');
                }

                // 音声の長さを取得
                const durationProbe = await ffmpeg.run('-i', audioFile.name, '-f', 'null', '-');
                const durationMatch = ffmpeg.log.match(/Duration: (\d{2}):(\d{2}):(\d{2}\.\d{2})/);
                const duration = durationMatch ? (parseInt(durationMatch[1]) * 3600 + parseInt(durationMatch[2]) * 60 + parseFloat(durationMatch[3])) : 10;

                // 音声を静止画付き動画に変換
                const outputName = `output_${audioFile.name}.mp4`;
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', imgName,
                    '-i', audioFile.name,
                    '-c:v', 'libx264',
                    '-tune', 'stillimage',
                    '-c:a', 'aac',
                    '-b:a', '192k',
                    '-pix_fmt', 'yuv420p',
                    '-t', duration.toString(),
                    '-vf', 'scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2',
                    outputName
                );

                // 出力ファイルを読み込み
                const data = ffmpeg.FS('readFile', outputName);
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoFile = new File([videoBlob], outputName, { type: 'video/mp4' });

                // クリーンアップ
                ffmpeg.FS('unlink', audioFile.name);
                if (thumbnailFile) ffmpeg.FS('unlink', imgName);
                ffmpeg.FS('unlink', outputName);

                return videoFile;
            } catch (error) {
                showError(`音声変換エラー: ${audioFile.name} (${error.message})`);
                return null;
            }
        }

        async function updateVideoInputs() {
            const videoFiles = document.getElementById('videoFiles').files;
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = '';
            videoQueue = [];

            if (videoFiles.length === 0) {
                document.getElementById('uploadButton').disabled = true;
                document.getElementById('bulkSettings').classList.add('hidden');
                return;
            }

            document.getElementById('bulkSettings').classList.remove('hidden');
            await initFFmpeg();

            for (let index = 0; index < videoFiles.length; index++) {
                let file = videoFiles[index];
                let isAudio = file.type.startsWith('audio/');

                if (isAudio) {
                    const thumbnailFile = document.getElementById('bulkThumbnail').files[0];
                    file = await convertAudioToVideo(file, thumbnailFile);
                    if (!file) continue;
                }

                const div = document.createElement('div');
                div.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow';
                div.id = `video${index}`;
                div.innerHTML = `
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="select${index}" class="mr-2" checked>
                        <h3 class="text-lg font-semibold">${file.name}${isAudio ? ' (音声から変換)' : ''}</h3>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium">タイトル</label>
                            <input type="text" id="title${index}" value="${file.name.replace(/\.[^/.]+$/, '')}" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">説明</label>
                            <textarea id="description${index}" class="w-full border rounded p-2 bg-white dark:bg-gray-600" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">公開設定</label>
                            <select id="privacy${index}" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                                <option value="private">非公開</option>
                                <option value="unlisted">限定公開</option>
                                <option value="public">公開</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">サムネイル</label>
                            <input type="file" id="thumbnail${index}" accept="image/jpeg,image/png" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">再生リスト</label>
                            <select id="playlist${index}" class="w-full border rounded p-2 bg-white dark:bg-gray-600">
                                <option value="">選択しない</option>
                                ${playlists.map(p => `<option value="${p.id}">${p.snippet.title}</option>`).join('')}
                            </select>
                            <input type="text" id="newPlaylist${index}" placeholder="新しい再生リストのタイトル" class="w-full border rounded p-2 mt-2 bg-white dark:bg-gray-600">
                            <button onclick="createNewPlaylist(${index})" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">新規作成</button>
                        </div>
                    </div>
                `;
                videoList.appendChild(div);
                videoQueue.push({ file, index, isAudio });
            }

            document.getElementById('uploadButton').disabled = videoQueue.length === 0;
        }

        function createNewPlaylist(index) {
            const title = document.getElementById(`newPlaylist${index}`).value;
            if (!title) {
                showError('再生リストのタイトルを入力してください');
                return;
            }
            createPlaylist(title, (playlistId) => {
                const select = document.getElementById(`playlist${index}`);
                const option = document.createElement('option');
                option.value = playlistId;
                option.text = title;
                select.appendChild(option);
                select.value = playlistId;
                updateBulkPlaylistOptions();
            });
        }

        function applyBulkSettings() {
            const bulkTitle = document.getElementById('bulkTitle').value;
            const bulkDescription = document.getElementById('bulkDescription').value;
            const bulkPrivacy = document.getElementById('bulkPrivacy').value;
            const bulkThumbnail = document.getElementById('bulkThumbnail').files[0];
            const bulkPlaylist = document.getElementById('bulkPlaylist').value;

            if (bulkThumbnail && bulkThumbnail.size > 2 * 1024 * 1024) {
                showError('サムネイルが大きすぎます（最大 2MB）');
                return;
            }

            videoQueue.forEach(({ index }) => {
                const checkbox = document.getElementById(`select${index}`);
                if (checkbox.checked) {
                    if (bulkTitle) document.getElementById(`title${index}`).value = bulkTitle;
                    if (bulkDescription) document.getElementById(`description${index}`).value = bulkDescription;
                    if (bulkPrivacy) document.getElementById(`privacy${index}`).value = bulkPrivacy;
                    if (bulkPlaylist) document.getElementById(`playlist${index}`).value = bulkPlaylist;
                    const videoDiv = document.getElementById(`video${index}`);
                    videoDiv.classList.add('applied');
                    setTimeout(() => videoDiv.classList.remove('applied'), 1000);
                }
            });

            document.getElementById('bulkTitle').value = '';
            document.getElementById('bulkDescription').value = '';
            document.getElementById('bulkPrivacy').value = '';
            document.getElementById('bulkPlaylist').value = '';
            document.getElementById('bulkThumbnail').value = '';
        }

        function startUpload() {
            if (videoQueue.length === 0) {
                showError('動画ファイルが選択されていません');
                return;
            }
            clearErrors();
            currentUploadIndex = 0;
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('uploadButton').disabled = true;
            uploadNextVideo();
        }

        function uploadNextVideo() {
            if (currentUploadIndex >= videoQueue.length) {
                document.getElementById('progressText').textContent = 'すべての動画のアップロードが完了しました！';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('uploadButton').disabled = false;
                document.getElementById('progressContainer').classList.add('hidden');
                return;
            }

            const { file, index } = videoQueue[currentUploadIndex];
            const title = document.getElementById(`title${index}`).value || 'テスト動画';
            const description = document.getElementById(`description${index}`).value || 'HTMLとJSでアップロード';
            const privacyStatus = document.getElementById(`privacy${index}`).value;
            const thumbnailFile = document.getElementById(`thumbnail${index}`).files[0];
            const playlistId = document.getElementById(`playlist${index}`).value;

            document.getElementById('progressText').textContent = `アップロード中: ${file.name} (${currentUploadIndex + 1}/${videoQueue.length})`;
            document.getElementById('progressBar').style.width = `${(currentUploadIndex / videoQueue.length) * 100}%`;

            if (file.size > 128 * 1024 * 1024) {
                showError(`動画ファイルが大きすぎます: ${file.name}（最大 128MB）`);
                currentUploadIndex++;
                uploadNextVideo();
                return;
            }

            const metadata = {
                snippet: { title, description, categoryId: '22' },
                status: { privacyStatus }
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('media', file);

            ensureValidToken(() => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status&uploadType=multipart', true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);

                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        console.log(`アップロード進捗 (${file.name}): ${percent.toFixed(2)}%`);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        const videoId = response.id;
                        console.log(`動画アップロード成功: ${file.name}, ビデオ ID: ${videoId}`);

                        if (thumbnailFile) {
                            uploadThumbnail(videoId, thumbnailFile);
                        }

                        if (playlistId) {
                            addToPlaylist(videoId, playlistId);
                        }

                        currentUploadIndex++;
                        document.getElementById('progressBar').style.width = `${((currentUploadIndex) / videoQueue.length) * 100}%`;
                        uploadNextVideo();
                    } else {
                        let errorMsg = xhr.responseText || '不明なエラー';
                        try {
                            const errorJson = JSON.parse(errorMsg);
                            if (errorJson.error && errorJson.error.reason === 'uploadLimitExceeded') {
                                errorMsg = `YouTube の動画アップロード制限に達しました: ${file.name}。電話番号を検証するか、別のアカウントを試してください。`;
                            }
                        } catch (e) {}
                        showError(`動画アップロード失敗 (${file.name}): ${xhr.status} ${xhr.statusText}\n詳細: ${errorMsg}`);
                        currentUploadIndex++;
                        uploadNextVideo();
                    }
                };

                xhr.onerror = () => {
                    showError(`動画アップロードネットワークエラー: ${file.name}`);
                    currentUploadIndex++;
                    uploadNextVideo();
                };

                xhr.send(formData);
            });
        }

        function uploadThumbnail(videoId, thumbnailFile) {
            if (thumbnailFile.size > 2 * 1024 * 1024) {
                showError(`サムネイルが大きすぎます: ${thumbnailFile.name}（最大 2MB）`);
                return;
            }

            const formData = new FormData();
            formData.append('file', thumbnailFile);

            ensureValidToken(() => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://www.googleapis.com/upload/youtube/v3/thumbnails/set?videoId=${videoId}&uploadType=media`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        console.log(`サムネイルアップロード成功: ${videoId}`);
                    } else {
                        showError(`サムネイルアップロード失敗 (${videoId}): ${xhr.status} ${xhr.statusText}`);
                    }
                };

                xhr.onerror = () => {
                    showError(`サムネイルネットワークエラー: ${videoId}`);
                };

                xhr.send(formData);
            });
        }

        function addToPlaylist(videoId, playlistId) {
            ensureValidToken(() => {
                gapi.client.youtube.playlistItems.insert({
                    part: 'snippet',
                    resource: {
                        snippet: {
                            playlistId: playlistId,
                            resourceId: { kind: 'youtube#video', videoId }
                        }
                    }
                }).then(() => {
                    console.log(`再生リストに追加: ${videoId}`);
                }).catch(error => {
                    showError('再生リストへの追加に失敗しました: ' + JSON.stringify(error));
                });
            });
        }

        document.getElementById('videoFiles').addEventListener('change', updateVideoInputs);
        initClient();
    </script>
</body>
</html>
